<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Private Notes</title>
  <style>
    :root {
      font-family: 'Georgia', serif;
      font-size: 18px;
      --bg: #fefefe;
      --fg: #111;
      --subtle: #999;
      --field-bg: #fff;
    }

    [data-theme="dark"] {
      --bg: #111;
      --fg: #fefefe;
      --subtle: #666;
      --field-bg: #1a1a1a;
    }

    body {
      margin: 0;
      padding: 3em 1em;
      max-width: 700px;
      margin-inline: auto;
      background: var(--bg);
      color: var(--fg);
      transition: background 0.3s ease, color 0.3s ease;
    }

    h1 {
      font-size: 1.2em;
      font-weight: normal;
      color: var(--subtle);
      margin-bottom: 1em;
    }

    textarea, input {
      width: 100%;
      font-family: 'Georgia', serif;
      font-size: 1em;
      padding: 1em;
      border: none;
      outline: none;
      background: var(--field-bg);
      color: var(--fg);
      box-shadow: 0 0 2px rgba(0,0,0,0.05);
      margin-bottom: 1em;
    }

    textarea {
      height: 60vh;
      resize: none;
      line-height: 1.5;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      align-items: center;
    }

    button {
      font-family: 'Georgia', serif;
      font-size: 0.9em;
      padding: 0.5em 1em;
      border: none;
      background: var(--field-bg);
      color: var(--fg);
      cursor: pointer;
      box-shadow: 0 0 2px rgba(0,0,0,0.05);
    }

    .status {
      flex-grow: 1;
      font-size: 0.85em;
      color: var(--subtle);
      text-align: right;
    }

    footer {
      margin-top: 1.5em;
      font-size: 0.85em;
      color: var(--subtle);
      text-align: center;
    }

    .theme-toggle {
      position: fixed;
      top: 1em;
      right: 1em;
      font-size: 0.9em;
      background: none;
      border: none;
      color: var(--subtle);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">Toggle Dark Mode</button>

  <h1>Note: <code id="note-id"></code></h1>

  <div class="controls">
    <input type="password" id="password" placeholder="Enter password">
    <button id="unlock">Unlock Note</button>
    <button id="encryptNow" style="display:none;">Encrypt Now</button>
    <button id="clear">Forget Note</button>
    <span class="status" id="status">Status: Unloaded</span>
  </div>

  <textarea id="note" placeholder="Start typing..." disabled></textarea>

  <footer>Saved only in this browser. Your secrets stay on your device. Encryption optional but recommended.</footer>

  <script>
    const path = window.location.pathname;
    const label = document.getElementById("note-id");
    label.textContent = path;

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    const el = document.getElementById("note");
    const pwd = document.getElementById("password");
    const unlockBtn = document.getElementById("unlock");
    const encryptBtn = document.getElementById("encryptNow");
    const clearBtn = document.getElementById("clear");
    const status = document.getElementById("status");

    let storageKey;
    let currentState = "locked";

    async function hashKey(input) {
      const msgUint8 = enc.encode(input);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function getKey(pass) {
      const salt = enc.encode("static-salt");
      const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: salt,
          iterations: 100000,
          hash: "SHA-256"
        },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptNote(text, pass) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKey(pass);
      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(text)
      );
      return JSON.stringify({
        iv: Array.from(iv),
        encrypted: Array.from(new Uint8Array(ciphertext))
      });
    }

    async function decryptNote(data, pass) {
      const key = await getKey(pass);
      const iv = new Uint8Array(data.iv);
      const ciphertext = new Uint8Array(data.encrypted);
      try {
        const plaintext = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv },
          key,
          ciphertext
        );
        return dec.decode(plaintext);
      } catch {
        alert("Wrong password or corrupted data.");
        return "";
      }
    }

    let saveTimeout;

    function updateStatus(text) {
      status.textContent = "Status: " + text;
    }

    async function loadNote() {
      storageKey = await hashKey("note:" + path);
      const raw = localStorage.getItem(storageKey);
      if (!raw) {
        currentState = "new";
        el.disabled = false;
        updateStatus("Unencrypted");
        return;
      }

      try {
        const data = JSON.parse(raw);
        if (data.encrypted) {
          currentState = "locked";
          el.value = "";
          el.disabled = true;
          updateStatus("Locked (requires password)");
        } else {
          currentState = "plain";
          el.value = data;
          el.disabled = false;
          updateStatus("Unencrypted");
        }
      } catch {
        el.value = raw;
        currentState = "plain";
        el.disabled = false;
        updateStatus("Unencrypted");
      }
    }

    unlockBtn.addEventListener("click", async () => {
      const pass = pwd.value;
      if (!pass) return alert("Enter a password first.");
      const raw = localStorage.getItem(storageKey);
      if (!raw) return;

      const data = JSON.parse(raw);
      if (!data.encrypted) {
        el.value = data;
        el.disabled = false;
        currentState = "plain";
        updateStatus("Unencrypted");
        return;
      }

      const decrypted = await decryptNote(data, pass);
      if (decrypted) {
        el.value = decrypted;
        el.disabled = false;
        currentState = "decrypted";
        updateStatus("Decrypted");
      }
    });

    encryptBtn.addEventListener("click", async () => {
      const text = el.value;
      const pass = pwd.value;
      if (!pass) return alert("Enter a password first.");
      const encrypted = await encryptNote(text, pass);
      localStorage.setItem(storageKey, encrypted);
      currentState = "encrypted";
      updateStatus("Encrypted");
      encryptBtn.style.display = "none";
    });

    el.addEventListener("input", () => {
      if (pwd.value && currentState !== "encrypted" && currentState !== "decrypted") {
        encryptBtn.style.display = "inline-block";
      }
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        const text = el.value;
        const pass = pwd.value;
        if (pass && (currentState === "decrypted" || currentState === "encrypted")) {
          const encrypted = await encryptNote(text, pass);
          localStorage.setItem(storageKey, encrypted);
          currentState = "encrypted";
          updateStatus("Encrypted");
        } else {
          localStorage.setItem(storageKey, text);
          currentState = "plain";
          updateStatus("Unencrypted");
        }
      }, 500);
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Forget this note? This cannot be undone.")) {
        localStorage.removeItem(storageKey);
        el.value = "";
        el.disabled = false;
        pwd.value = "";
        currentState = "new";
        updateStatus("Deleted");
      }
    });

    // DARK MODE TOGGLE
    const themeToggle = document.getElementById("themeToggle");
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("theme");

    if (savedTheme === "dark") {
      root.setAttribute("data-theme", "dark");
    }

    themeToggle.addEventListener("click", () => {
      const current = root.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    loadNote();
  </script>
</body>
</html>