<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>nox</title>
  <style>
    :root {
      font-family: 'Georgia', serif;
      font-size: 18px;
      --bg: #fefefe;
      --fg: #111;
      --subtle: #888;
      --field-bg: #fff;
    }

    [data-theme="dark"] {
      --bg: #111;
      --fg: #fefefe;
      --subtle: #666;
      --field-bg: #1a1a1a;
    }

    [data-stealth="true"] .app {
      display: none;
    }

    [data-stealth="true"] .stealth-screen {
      display: block;
    }

    body {
      margin: 0;
      padding: 2em 1em 4em;
      background: var(--bg);
      color: var(--fg);
      transition: background 0.3s ease, color 0.3s ease;
      max-width: 800px;
      margin-inline: auto;
    }

    h1 {
      font-size: 1em;
      font-weight: normal;
      color: var(--subtle);
      margin-bottom: 1em;
      word-break: break-all;
    }

    textarea, input, select {
      width: 100%;
      font-family: 'Georgia', serif;
      font-size: 1em;
      padding: 1em;
      border: none;
      outline: none;
      background: var(--field-bg);
      color: var(--fg);
      box-shadow: 0 0 2px rgba(0,0,0,0.05);
      margin-bottom: 1em;
    }

    textarea {
      height: 60vh;
      resize: none;
      line-height: 1.5;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      align-items: center;
    }

    button {
      font-family: 'Georgia', serif;
      font-size: 0.9em;
      padding: 0.5em 1em;
      border: none;
      background: var(--field-bg);
      color: var(--fg);
      cursor: pointer;
      box-shadow: 0 0 2px rgba(0,0,0,0.05);
    }

    .status {
      flex-grow: 1;
      font-size: 0.85em;
      color: var(--subtle);
      text-align: right;
    }

    footer {
      margin-top: 2em;
      font-size: 0.8em;
      color: var(--subtle);
      text-align: center;
    }

    .theme-toggle {
      position: fixed;
      top: 1em;
      right: 1em;
      font-size: 0.9em;
      background: none;
      border: none;
      color: var(--subtle);
      cursor: pointer;
    }

    .stealth-screen {
      display: none;
      text-align: center;
      font-size: 1em;
      color: var(--subtle);
      margin-top: 4em;
    }

    @media (max-width: 500px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .status {
        text-align: left;
      }

      .theme-toggle {
        position: static;
        display: block;
        margin-bottom: 1em;
        text-align: right;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">Toggle Dark Mode</button>

  <div class="stealth-screen" id="stealthScreen">
    <p>Nothing to see here.</p>
  </div>

  <div class="app" id="app">
    <h1>Note: <code id="note-id"></code></h1>

    <div class="controls">
      <input type="password" id="password" placeholder="Enter password">
      <button id="unlock">Unlock</button>
      <button id="encryptNow" style="display:none;">Encrypt Now</button>
      <button id="clear">Forget</button>
      <select id="selfDestruct">
        <option value="">No Expiry</option>
        <option value="5">Self-Destruct: 5 min</option>
        <option value="60">1 hour</option>
        <option value="1440">1 day</option>
      </select>
      <span class="status" id="status">Status: Unloaded</span>
    </div>

    <textarea id="note" placeholder="Start typing..." disabled></textarea>
  </div>

  <footer>
    Stored only in this browser. Optional encryption & stealth.<br>
    <small>nox v0.14</small>
  </footer>

  <script>
    const path = window.location.pathname;
    const label = document.getElementById("note-id");
    label.textContent = path;

    const el = document.getElementById("note");
    const pwd = document.getElementById("password");
    const unlockBtn = document.getElementById("unlock");
    const encryptBtn = document.getElementById("encryptNow");
    const clearBtn = document.getElementById("clear");
    const status = document.getElementById("status");
    const destructSelect = document.getElementById("selfDestruct");
    const stealthScreen = document.getElementById("stealthScreen");
    const appDiv = document.getElementById("app");

    let storageKey, currentState = "locked", saveTimeout;

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    async function hashKey(input) {
      const hashBuffer = await crypto.subtle.digest("SHA-256", enc.encode(input));
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function getKey(pass) {
      const salt = enc.encode("static-salt");
      const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
      return crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptNote(text, pass, expiry) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKey(pass);
      const ciphertext = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, enc.encode(text));
      return JSON.stringify({
        iv: Array.from(iv),
        encrypted: Array.from(new Uint8Array(ciphertext)),
        meta: {
          expiresAt: expiry ? Date.now() + expiry * 60 * 1000 : null
        }
      });
    }

    async function decryptNote(data, pass) {
      if (data.meta?.expiresAt && Date.now() > data.meta.expiresAt) {
        localStorage.removeItem(storageKey);
        alert("This note has self-destructed.");
        return "";
      }
      const key = await getKey(pass);
      const iv = new Uint8Array(data.iv);
      const ciphertext = new Uint8Array(data.encrypted);
      try {
        const plaintext = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ciphertext);
        return dec.decode(plaintext);
      } catch {
        alert("Wrong password or corrupted data.");
        return "";
      }
    }

    function updateStatus(text) {
      status.textContent = "Status: " + text;
    }

    async function loadNote() {
      storageKey = await hashKey("note:" + path);
      const raw = localStorage.getItem(storageKey);
      if (!raw) {
        currentState = "new";
        el.disabled = false;
        updateStatus("Unencrypted");
        return;
      }

      try {
        const data = JSON.parse(raw);
        if (data.meta?.stealth) {
          document.documentElement.setAttribute("data-stealth", "true");
        }
        if (data.encrypted) {
          currentState = "locked";
          el.value = "";
          el.disabled = true;
          updateStatus("Locked (requires password)");
        } else {
          el.value = data;
          currentState = "plain";
          el.disabled = false;
          updateStatus("Unencrypted");
        }
      } catch {
        el.value = raw;
        currentState = "plain";
        el.disabled = false;
        updateStatus("Unencrypted");
      }
    }

    function maybeShowEncryptNow() {
      if (pwd.value && el.value && !["encrypted", "decrypted"].includes(currentState)) {
        encryptBtn.style.display = "inline-block";
      } else {
        encryptBtn.style.display = "none";
      }
    }

    pwd.addEventListener("input", maybeShowEncryptNow);

    unlockBtn.addEventListener("click", async () => {
      const raw = localStorage.getItem(storageKey);
      if (!pwd.value || !raw) return;
      const data = JSON.parse(raw);
      const decrypted = await decryptNote(data, pwd.value);
      if (decrypted) {
        el.value = decrypted;
        el.disabled = false;
        currentState = "decrypted";
        updateStatus("Decrypted");
        document.documentElement.removeAttribute("data-stealth");
      }
    });

    encryptBtn.addEventListener("click", async () => {
      const encrypted = await encryptNote(el.value, pwd.value, parseInt(destructSelect.value));
      localStorage.setItem(storageKey, encrypted);
      currentState = "encrypted";
      updateStatus("Encrypted");
      encryptBtn.style.display = "none";
    });

    el.addEventListener("input", () => {
      maybeShowEncryptNow();
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        const text = el.value;
        const pass = pwd.value;
        const expiry = parseInt(destructSelect.value);
        if (pass && ["decrypted", "encrypted"].includes(currentState)) {
          const encrypted = await encryptNote(text, pass, expiry);
          localStorage.setItem(storageKey, encrypted);
          currentState = "encrypted";
          updateStatus("Encrypted");
        } else {
          localStorage.setItem(storageKey, text);
          currentState = "plain";
          updateStatus("Unencrypted");
        }
      }, 500);
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Forget this note?")) {
        localStorage.removeItem(storageKey);
        el.value = "";
        el.disabled = false;
        pwd.value = "";
        currentState = "new";
        updateStatus("Deleted");
      }
    });

    // Dark Mode Toggle
    const themeToggle = document.getElementById("themeToggle");
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") root.setAttribute("data-theme", "dark");

    themeToggle.addEventListener("click", () => {
      const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    loadNote();
  </script>
</body>
</html>