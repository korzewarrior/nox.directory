<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>nox</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 16px;
      --bg: #fff;
      --fg: #111;
      --subtle: #777;
      --field-bg: #f0f0f0;
      --accent: #007aff;
    }

    [data-theme="dark"] {
      --bg: #0f0f0f;
      --fg: #eee;
      --subtle: #555;
      --field-bg: #1b1b1b;
    }

    body {
      margin: 0;
      padding: 1.5em;
      background: var(--bg);
      color: var(--fg);
      max-width: 700px;
      margin-inline: auto;
      transition: background 0.2s ease, color 0.2s ease;
    }

    h1 {
      font-size: 1em;
      font-weight: normal;
      color: var(--subtle);
      margin-bottom: 1em;
      word-break: break-word;
    }

    textarea, input {
      width: 100%;
      font: inherit;
      padding: 1em;
      border: 1px solid var(--subtle);
      border-radius: 0;
      background: var(--field-bg);
      color: var(--fg);
      margin-bottom: 1em;
    }

    textarea {
      height: 60vh;
      resize: none;
      line-height: 1.5;
    }

    button {
      font: inherit;
      padding: 0.6em 1.2em;
      border: 1px solid var(--subtle);
      border-radius: 0;
      background: none;
      color: var(--fg);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: var(--field-bg);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      align-items: center;
    }

    .status {
      flex-grow: 1;
      font-size: 0.85em;
      color: var(--subtle);
      text-align: right;
    }

    .theme-toggle {
      float: right;
      font-size: 0.85em;
      margin-bottom: 1em;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.4em 0.8em;
      cursor: pointer;
    }

    footer {
      margin-top: 2em;
      font-size: 0.8em;
      text-align: center;
      color: var(--subtle);
    }

    @media (max-width: 500px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .status {
        text-align: left;
      }

      .theme-toggle {
        float: none;
        margin-bottom: 1em;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">Toggle Mode</button>

  <h1>Note: <code id="note-id"></code></h1>

  <div class="controls">
    <input type="password" id="password" placeholder="Enter password (optional)">
    <button id="unlock">Unlock</button>
    <button id="encryptNow" style="display:none;">Encrypt Now</button>
    <button id="clear">Forget</button>
    <span class="status" id="status">Status: Ready</span>
  </div>

  <textarea id="note" placeholder="Start typing..." disabled></textarea>

  <footer>
    Stored only in this browser. Private by design.<br>
    <small>nox v0.15.1</small>
  </footer>

  <script>
    const path = window.location.pathname;
    const label = document.getElementById("note-id");
    label.textContent = path;

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    const el = document.getElementById("note");
    const pwd = document.getElementById("password");
    const unlockBtn = document.getElementById("unlock");
    const encryptBtn = document.getElementById("encryptNow");
    const clearBtn = document.getElementById("clear");
    const status = document.getElementById("status");

    let storageKey;
    let currentState = "plain";
    let saveTimeout;
    let isLocked = false;

    function updateStatus(text) {
      status.textContent = "Status: " + text;
    }

    function maybeShowEncryptNow() {
      encryptBtn.style.display = (pwd.value && el.value && currentState === "plain") ? "inline-block" : "none";
    }

    async function hashKey(input) {
      const hashBuffer = await crypto.subtle.digest("SHA-256", enc.encode(input));
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function getKey(pass) {
      const salt = enc.encode("static-salt");
      const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
      return crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptNote(text, pass) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKey(pass);
      const ciphertext = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, enc.encode(text));
      return JSON.stringify({ iv: Array.from(iv), encrypted: Array.from(new Uint8Array(ciphertext)) });
    }

    async function decryptNote(data, pass) {
      try {
        const key = await getKey(pass);
        const iv = new Uint8Array(data.iv);
        const ciphertext = new Uint8Array(data.encrypted);
        const plaintext = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ciphertext);
        return dec.decode(plaintext);
      } catch {
        alert("Wrong password or corrupted data.");
        return "";
      }
    }

    pwd.addEventListener("input", maybeShowEncryptNow);

    el.addEventListener("input", () => {
      if (isLocked) return; // don't allow saving if locked
      maybeShowEncryptNow();
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        const text = el.value;
        const pass = pwd.value;
        if (pass && currentState !== "encrypted") {
          const encrypted = await encryptNote(text, pass);
          localStorage.setItem(storageKey, encrypted);
          currentState = "encrypted";
          updateStatus("Encrypted");
        } else {
          localStorage.setItem(storageKey, text);
          currentState = "plain";
          updateStatus("Saved");
        }
      }, 500);
    });

    encryptBtn.addEventListener("click", async () => {
      const text = el.value;
      const pass = pwd.value;
      const encrypted = await encryptNote(text, pass);
      localStorage.setItem(storageKey, encrypted);
      currentState = "encrypted";
      updateStatus("Encrypted");
      encryptBtn.style.display = "none";
    });

    unlockBtn.addEventListener("click", async () => {
      const raw = localStorage.getItem(storageKey);
      if (!pwd.value || !raw) return;
      const data = JSON.parse(raw);
      if (!data.encrypted) return;
      const decrypted = await decryptNote(data, pwd.value);
      if (decrypted) {
        el.value = decrypted;
        currentState = "decrypted";
        isLocked = false;
        el.removeAttribute("disabled");
        updateStatus("Decrypted");
      }
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Forget this note?")) {
        localStorage.removeItem(storageKey);
        el.value = "";
        currentState = "plain";
        isLocked = false;
        el.removeAttribute("disabled");
        updateStatus("Cleared");
      }
    });

    const themeToggle = document.getElementById("themeToggle");
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") root.setAttribute("data-theme", "dark");

    themeToggle.addEventListener("click", () => {
      const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    (async function init() {
      storageKey = await hashKey("note:" + path);
      const raw = localStorage.getItem(storageKey);
      if (!raw) {
        el.removeAttribute("disabled");
        updateStatus("Ready");
        return;
      }
      try {
        const data = JSON.parse(raw);
        if (data.encrypted) {
          currentState = "encrypted";
          isLocked = true;
          el.setAttribute("disabled", true);
          updateStatus("Locked (Enter password to unlock)");
        } else {
          el.value = data;
          currentState = "plain";
          el.removeAttribute("disabled");
          updateStatus("Loaded");
        }
      } catch {
        el.value = raw;
        el.removeAttribute("disabled");
        updateStatus("Loaded");
      }
    })();
  </script>
</body>
</html>